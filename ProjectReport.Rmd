---
title: Project Report
output:
  html_document: default
  pdf_document: default
params: 
  
---



```{r data crunch, warning=FALSE, include=FALSE}
library(readr) 
library(magrittr) 
library(dplyr) 
library(kableExtra) 
library(rmarkdown)
library(rlang)
library(plotly)
library(dplyr)
library(crosstalk)
library(tidyverse)
library(leaflet)
library(DT)
erisk_item <- read_csv("data/RiskItem_FullView_Update.csv")
risk_item_db<-data.frame(erisk_item)
erisk_project <- read_csv("data/RiskProject_FullView.csv")
risk_project_db<-data.frame(erisk_project)


#cast numeric to string
risk_item_db$RISK_ID<-as.character(risk_item_db$RISK_ID)
risk_item_db$riskIDCode<-paste(risk_item_db$RISK_ID,"-",risk_item_db$DISCIPLINE_ACRONYM)

erisk_ItemProj<-left_join(risk_item_db, risk_project_db, by = "PROJECT_ID")
erisk_testing<-erisk_ItemProj[,c(3,4,5,6,8,22,27,32,40,51,56,64,65)]

erisk_testing$PROJECT_NAME.x<-as.factor(erisk_testing$PROJECT_NAME.x)
erisk_testing$USACE_ORGANIZATION<-as.factor(erisk_testing$USACE_ORGANIZATION)

erisk_testing<-erisk_testing %>%
  rename("Project Name" = PROJECT_NAME.x,
         "Risk" = RISK_NAME,
         "Risk Category" = RISKCATEGORY,
         "Risk Statement" = RISK_STATEMENT,
         "USACE Organization" = USACE_ORGANIZATION)


erisk_testing<-erisk_testing %>% 
  dplyr::mutate("Cost Risk" = case_when(COST_RISK_RANKING == 0 ~ "",
                                      COST_RISK_RANKING == 1 ~ "Opportunity",
                                      COST_RISK_RANKING == 2 ~ "Low",
                                      COST_RISK_RANKING == 3 ~ "Moderate",
                                      COST_RISK_RANKING == 4 ~ "High")) %>%
                mutate("Performance Risk" = case_when(PERFORMANCEIMPACT_RISK_RANKING == 0 ~ "",
                                                      PERFORMANCEIMPACT_RISK_RANKING == 1 ~ "Opportunity",
                                                      PERFORMANCEIMPACT_RISK_RANKING == 2 ~ "Low",
                                                      PERFORMANCEIMPACT_RISK_RANKING == 3 ~ "Moderate",
                                                      PERFORMANCEIMPACT_RISK_RANKING == 4 ~ "High"))%>%
                mutate("Schedule Risk" = case_when(SCHEDULE_RISK_RANKING == 0 ~ "",
                                                   SCHEDULE_RISK_RANKING == 1 ~ "Opportunity",
                                                   SCHEDULE_RISK_RANKING == 2 ~ "Low",
                                                   SCHEDULE_RISK_RANKING == 3 ~ "Moderate",
                                                   SCHEDULE_RISK_RANKING == 4 ~ "High"))

  

```

```{r leaflet map, echo = FALSE, warning=FALSE}
erisk_testing1<-erisk_testing %>%
  select('Project Name', 'Risk', 'Risk Category', 'Risk Statement', 'Cost Risk', 'Performance Risk','Schedule Risk',riskIDCode, PROJECT_LATITUDE, PROJECT_LONGITUDE, 'USACE Organization')


cost_Sample<-erisk_testing1 %>%
  filter(`Cost Risk`!="") %>% 
  group_by(`Project Name`) %>%
  count(`Cost Risk`)%>%
  group_by(`Project Name`) %>%
  mutate(perc = round(n/sum(n)*100,2)) %>%
   mutate('color' = case_when(`Cost Risk` == "Opportunity" ~ 'deepskyblue', 
  `Cost Risk`=='Low'~'green', 
  `Cost Risk` =='Moderate'~'orange',
  `Cost Risk` == 'High'~ 'red')) %>%
  plotly::arrange(factor(`Cost Risk`,levels=c('Opportunity', 'Low', 'Moderate', 'High')))
 


shared_proj<-SharedData$new(erisk_testing1, group = "projfilt")


cost_risk_plot<-erisk_testing1 %>%
  filter(`Cost Risk`!="") %>% 
  group_by(`Project Name`) %>%
  count(`Cost Risk`)%>%
  group_by(`Project Name`) %>%
  mutate(perc = round(n/sum(n)*100,2)) %>%
   mutate('color' = case_when(`Cost Risk` == "Opportunity" ~ 'deepskyblue', 
  `Cost Risk`=='Low'~'green', 
  `Cost Risk` =='Moderate'~'orange',
  `Cost Risk` == 'High'~ 'red')) %>%
  plotly::arrange(factor(`Cost Risk`,levels=c('Opportunity', 'Low', 'Moderate', 'High')))%>%
  SharedData$new(group = "projfilt", key = ~`Project Name`)

schedule_risk_plot<-erisk_testing1 %>%
  filter(`Schedule Risk`!="") %>%
  group_by(`Project Name`) %>%
  count(`Schedule Risk`)%>%
  group_by(`Project Name`) %>%
  mutate(perc = round(n/sum(n)*100,2))%>%
  plotly::arrange(factor(`Schedule Risk`,levels=c('Opportunity', 'Low', 'Moderate', 'High')))%>%
   mutate('color' = case_when(`Schedule Risk` == "Opportunity" ~ 'deepskyblue', 
  `Schedule Risk`=='Low'~'green', 
  `Schedule Risk` =='Moderate'~'orange',
  `Schedule Risk` == 'High'~ 'red')) %>%
  SharedData$new(group = "projfilt")


perform_risk_plot<-erisk_testing1 %>%
  filter(`Performance Risk`!="") %>%
  group_by(`Project Name`) %>%
  count(`Performance Risk`)%>%
  group_by(`Project Name`) %>%
  mutate(perc = round(n/sum(n)*100,2))%>%
  plotly::arrange(factor(`Performance Risk`,levels=c('Opportunity', 'Low', 'Moderate', 'High')))%>%
   mutate('color' = case_when(`Performance Risk` == "Opportunity" ~ 'deepskyblue', 
  `Performance Risk`=='Low'~'green', 
  `Performance Risk` =='Moderate'~'orange',
  `Performance Risk` == 'High'~ 'red')) %>%
  SharedData$new(group = "projfilt")

filter_select(
  id = "prj",
  label = "Project",
  sharedData = shared_proj,
  group = ~`Project Name`
)

# filter_select(
#   id = "dst",
#   label = "District",
#   sharedData = shared_proj,
#   group = ~`USACE Organization`
# )




shared_proj %>%
  leaflet() %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircleMarkers(lng=~PROJECT_LONGITUDE, lat=~PROJECT_LATITUDE,color="aqua", fillColor="aqua", weight=2)



cost_plot<- cost_risk_plot %>%
  plot_ly(type = "pie", values = ~n, labels = ~`Cost Risk`, sort=FALSE, marker = list(colors = ~color))%>%
  layout(title = "Cost Risk",  showlegend = F,
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
cost_plot

# schedule_plot<-schedule_risk_plot%>% 
#   plot_ly(labels = ~`Schedule Risk`, values = ~n, sort=FALSE, marker = list(colors = ~color)) %>%
#   add_pie() %>%
#   layout(title = "Schedule Risk",  showlegend = F,
#                       xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
#                       yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
# 
# performance_plot<-perform_risk_plot %>%
#   plot_ly(labels = ~`Performance Risk`, values = ~n, sort=FALSE, marker = list(colors = ~color)) %>%
#   add_pie() %>%
#   layout(title = "Performance Risk",  showlegend = F,
#                       xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
#                       yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
# 

# plotty<-bscols(widths = c(4,4,4), cost_plot, schedule_plot, performance_plot)

# plotty

shared_proj %>%
  DT::datatable(filter = "top",
                extensions = 'Buttons', 
                options = list(buttons = c('copy','csv','excel','pdf'),
                          lengthMenu=list(c(10,30, 50, -1), c('10', '30', '50', 'All')),
                          paging = T)) %>%
     formatStyle('Performance Risk', backgroundColor = styleEqual(
                     c("", 'Opportunity', 'Low', 'Moderate', 'High'),
                     c('white', 'deepskyblue', 'green', 'orange', 'red')
                   )) %>%
                   formatStyle('Cost Risk', backgroundColor = styleEqual(
                    c("", 'Opportunity', 'Low', 'Moderate', 'High'),
                     c('white', 'deepskyblue', 'green', 'orange', 'red')
                   )) %>%
                   formatStyle('Schedule Risk', backgroundColor = styleEqual(
                     c("", 'Opportunity', 'Low', 'Moderate', 'High'),
                    c('white', 'deepskyblue', 'green', 'orange', 'red')
                   ))
```
