```{r data crunch, include=FALSE}
library(readr) 
library(magrittr) 
library(dplyr) 
library(kableExtra) 
library(rlang)
library(plotly)
library(dplyr)
library(crosstalk)
library(tidyverse)
library(leaflet)
library(DT)
erisk_item <- read_csv("data/RiskItem_FullView.csv")
risk_item_db<-data.frame(erisk_item)
erisk_project <- read_csv("data/RiskProject_FullView.csv")
risk_project_db<-data.frame(erisk_project)


#cast numeric to string
risk_item_db$RISK_ID<-as.character(risk_item_db$RISK_ID)
risk_item_db$riskIDCode<-paste(risk_item_db$RISK_ID,"-",risk_item_db$DISCIPLINE_ACRONYM)

erisk_ItemProj<-left_join(risk_item_db, risk_project_db, by = "PROJECT_ID")
erisk_testing<-erisk_ItemProj[,c(3,5,6,8,22,27,32,40,51,56,64,65)]

erisk_testing$PROJECT_NAME.x<-as.factor(erisk_testing$PROJECT_NAME.x)
erisk_testing$USACE_ORGANIZATION<-as.factor(erisk_testing$USACE_ORGANIZATION)

erisk_testing<-erisk_testing %>%
  rename(ProjectName = PROJECT_NAME.x,
         Risk = RISK_NAME,
         "Risk Category" = RISKCATEGORY,
         "Risk Statement" = RISK_STATEMENT)


erisk_testing<-erisk_testing %>% 
  dplyr::mutate("Cost Risk" = case_when(COST_RISK_RANKING == 0 ~ "",
                                      COST_RISK_RANKING == 1 ~ "Opportunity",
                                      COST_RISK_RANKING == 2 ~ "Low",
                                      COST_RISK_RANKING == 3 ~ "Moderate",
                                      COST_RISK_RANKING == 4 ~ "High")) %>%
                mutate("Performance Risk" = case_when(PERFORMANCEIMPACT_RISK_RANKING == 0 ~ "",
                                                      PERFORMANCEIMPACT_RISK_RANKING == 1 ~ "Opportunity",
                                                      PERFORMANCEIMPACT_RISK_RANKING == 2 ~ "Low",
                                                      PERFORMANCEIMPACT_RISK_RANKING == 3 ~ "Moderate",
                                                      PERFORMANCEIMPACT_RISK_RANKING == 4 ~ "High"))%>%
                mutate("Schedule Risk" = case_when(SCHEDULE_RISK_RANKING == 0 ~ "",
                                                   SCHEDULE_RISK_RANKING == 1 ~ "Opportunity",
                                                   SCHEDULE_RISK_RANKING == 2 ~ "Low",
                                                   SCHEDULE_RISK_RANKING == 3 ~ "Moderate",
                                                   SCHEDULE_RISK_RANKING == 4 ~ "High"))



```

```{r leaflet map}
erisk_testing2<-erisk_testing %>%
  select(ProjectName, Risk, 'Risk Category', 'Risk Statement', 'Cost Risk', 'Performance Risk', 'Schedule Risk', PROJECT_LATITUDE, PROJECT_LONGITUDE, USACE_ORGANIZATION)

shared_proj<-SharedData$new(erisk_testing2)
erisk_testing1<-erisk_testing %>%
  select(ProjectName, Risk, 'Risk Category', 'Risk Statement', 'Cost Risk', 'Performance Risk', 'Schedule Risk', USACE_ORGANIZATION)
shared_proj2<-SharedData$new(erisk_testing1)

filter_select(
  id = "prj",
  label = "Project",
  sharedData = shared_proj,
  group = ~ProjectName
)

filter_select(
  id = "dst",
  label = "District",
  sharedData = shared_proj,
  group = ~USACE_ORGANIZATION
)

shared_proj %>%
  leaflet() %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircleMarkers(lng=~PROJECT_LONGITUDE, lat=~PROJECT_LATITUDE,color="aqua", fillColor="aqua", weight=2)

shared_proj %>%
  group_by('Cost Risk')%>%
  plot_ly(labels = ~'Cost Risk', values = ~count('Cost Risk'), text = ~count('Cost Risk')) %>%
  add_pie(hole = 0.6) %>%
  layout(title = "Donut charts using Plotly",  showlegend = T,
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         colorway = c('green','orange','red'))

    
  
shared_proj %>%
  DT::datatable(filter = "top",
                extensions = 'Buttons', 
                options = list(buttons = c('copy','csv','excel','pdf'),
                          lengthMenu=list(c(10,30, 50, -1), c('10', '30', '50', 'All')),
                          paging = T)) %>%
     formatStyle('Performance Risk', backgroundColor = styleEqual(
                     c("", 'Opportunity', 'Low', 'Moderate', 'High'),
                     c('white', 'deepskyblue', 'green', 'orange', 'red')
                   )) %>%
                   formatStyle('Cost Risk', backgroundColor = styleEqual(
                    c("", 'Opportunity', 'Low', 'Moderate', 'High'),
                     c('white', 'deepskyblue', 'green', 'orange', 'red')
                   )) %>%
                   formatStyle('Schedule Risk', backgroundColor = styleEqual(
                     c("", 'Opportunity', 'Low', 'Moderate', 'High'),
                    c('white', 'deepskyblue', 'green', 'orange', 'red')
                   ))
```
