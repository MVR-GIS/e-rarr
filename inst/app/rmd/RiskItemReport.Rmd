---
title: ""
runtime: shiny
output: html_document
params: 
  riskID: "RLE-2 Real Estate Estate Acquisition"
  projID: LaGrange New 1200-Foot Lock
  p2ID: 	""
---

```{css, echo=FALSE, eval=FALSE}
h2, h3, h4 {
  text-align: center;
}

body{ /* Normal  */
      font-size: 12px;
  }

th {    vertical-align: top;    
    white-space: nowrap;
    padding: 5px;
    
}
td {    vertical-align: top;
  padding: 5px;
}


@media print {
body {-webkit-print-color-adjust: exact;}
  .font-size{ 9pt;
  }
  .item-box {
    page-break-inside: avoid;
  }
  .section-box {
    page-break-inside: avoid;
  }

  .page-break {
  page-break-after: always;
  }

}

```

```{r echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library(dplyr) 
library(kableExtra) 
library(rlang)
library(plotly)
library(ggplot2)
library(ggrepel)
library(dplyr)
library(knitr)
library(crosstalk)
library(tidyverse)
library(english)
library(DT)
library(readr)
library(erarr)
options(scipen = 999)

risk_item_db <- readr::read_csv("../data/erisk_item.csv")
risk_project_db <- readr::read_csv("../data/erisk_project.csv")
risk_transact <- readr::read_csv("../data/risk_transact.csv")
milestone_df<- readr::read_csv("../data/phase_milestone.csv")
risk_modeled<-readr::read_csv("../data/erisk_modeled.csv")
risk_treatment<-readr::read_csv("../data/risk_treat.csv")
checkimagepath<-"../www/check.png"
headers<-c("Cost Impact", "Schedule Impact","Performance Impact")



#erisk_ItemProj<-left_join(risk_item_db, risk_project_db, by =c("PROJECT_ID"), relationship = "many-to-many") 

erisk_ItemProj <- risk_item_db |>
  mutate(RISK_NAME_ID = paste(RISK_IDENTIFIER,RISK_NAME))                 

risk_item_filt <- risk_item_db |>
  mutate(RISK_NAME_ID = paste(RISK_IDENTIFIER,RISK_NAME))|>
  select(RISK_ID, PROJECT_ID,RISK_NAME, RISK_NAME_ID,P2_NUMBER)



RiskImpactTable <- erisk_ItemProj |>
  select("RISK_ID","RISK_NAME_ID","RISK_NAME","RISK_IDENTIFIER","P2_NUMBER", "PROJECT_ID",
         "PROJECT_NAME", "RISK_NAME","RISKCATEGORY", 
         "DISCIPLINE", 
         "RISK_STATEMENT","LIKELIHOOD_DESC", "PROB_OCCURRENCE_EVIDENCE",  
         "COST_IMPACT_LOWEST", "COST_IMPACT_MOSTLIKELY", "COST_IMPACT_HIGHEST",
         "COST_IMPACT_EVIDENCE","SCHEDULE_IMPACT_LOWEST", 
         "SCHEDULE_IMPACT_MOSTLIKELY", "SCHEDULE_IMPACT_HIGHEST", 
         "SCHEDULE_IMPACT_EVIDENCE", "LIFECYCLEPHASENAME", 
         "PERFORMANCEIMPACT_DESC", "PERFORMANCEIMPACT","PERFORMANCE_IMPACT_DESC" 
         ,"PROJECTPHASEID", 
         "MILESTONE","PROJECTMILESTONEID","RISK_MANAGER", "COST_IMPACT_DISTTYPE", 
         "SCHEDULE_IMPACT_DISTTYPE", "NO_PERFORMANCE_IMPACT", "NO_COST_IMPACT",
         "NO_SCHEDULE_IMPACT")

risk_transact<-left_join(risk_transact, risk_item_filt, by=c("PROJECT_ID","RISK_ID"), 
                         relationship = "many-to-many", keep=FALSE)     
risk_treat<-left_join(risk_treatment, risk_item_filt, by=c("PROJECT_ID", "RISK_ID"),
                      relationship = "many-to-many", keep=FALSE)

risk_modeled <-left_join(risk_modeled, risk_item_filt, by=c("PROJECT_ID", "RISK_ID"), 
                         keep=FALSE)

```

```{r echo=FALSE, eval = params$projID != ""}
risk_item<-filter(RiskImpactTable, RiskImpactTable$RISK_NAME_ID == params$riskID,
                  RiskImpactTable$PROJECT_NAME == params$projID)
risk_treatment<-filter(risk_treat, risk_treat$PROJECT_ID == params$projID, 
                        risk_treat$RISK_NAME_ID == params$riskID)
risk_model<-filter(risk_modeled, risk_modeled$PROJECT_ID == params$projID, 
                       risk_modeled$RISK_NAME_ID == params$riskID)
risk_item_transact<-filter(risk_transact, risk_transact$RISK_NAME_ID == params$riskID,
                           risk_transact$PROJECT_NAME == params$projID)
```

```{r echo=FALSE, eval = params$p2ID != ""}
risk_item<-filter(RiskImpactTable, RiskImpactTable$RISK_NAME_ID == params$riskID, 
                  RiskImpactTable$P2_NUMBER == params$p2ID)
 risk_treatment<-filter(risk_treat, risk_treat$PROJECT_NAME == params$projID, 
                        risk_treat$RISK_NAME_ID == params$riskID)
risk_model<-filter(risk_modeled, risk_modeled$PROJECT_ID == params$projID, 
                       risk_modeled$RISK_NAME_ID == params$riskID)
risk_item_transact<-filter(risk_transact, risk_transact$RISK_NAME_ID == params$riskID,
                           risk_transact$P2_NUMBER == params$p2ID)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
treat_condit <- ifelse(nrow(risk_treatment)>0,TRUE,FALSE)
monte_condit <- ifelse(nrow(risk_model>0),TRUE,FALSE)
```


###### Report Created On: `r format(Sys.time(), '%d %B, %Y')`
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

header<-paste("Project:",risk_item$PROJECT_NAME," ",(risk_item$RISK_IDENTIFIER))


cat("####",header)
```

##### Risk Phase:`r risk_item$LIFECYCLEPHASENAME`, Category:`r risk_item$RISKCATEGORY`

##### Risk Summary: `r risk_item$RISK_NAME`

<center>
```{r milestoneplot, fig.height=1.40, fig.width=8, echo=FALSE, message=FALSE}
mileplot<-erarr::milestoneplot(riskitem=risk_item, milestonedf = milestone_df)

knitr::include_graphics("mileplot.png")

```
</center>

###### **Lead Discipline:** `r risk_item$DISCIPLINE`

`r risk_item$RISK_STATEMENT` 

`r if(!monte_condit){"Monte carlo simulations have not been completed for this risk item"}`
<center>
```{r monte carlo plots, message=FALSE, echo=FALSE,warning=FALSE, eval= monte_condit, fig.height=1.75, fig.width=7}
ranking = c("Opportunity", "Low", "Medium","High")
colors = c('rgb(31,120,180)','rgb(51,160,44)','rgb(255,127,0)','rgb(227,26,28)')
cost_values = c(risk_model$COST_PROBOPP,risk_model$COST_PROBLOW,risk_model$COST_PROBMOD,risk_model$COST_PROBHIGH)
schedule_values= c(risk_model$SCHEDULE_PROBOPP,risk_model$SCHEDULE_PROBLOW,risk_model$SCHEDULE_PROBMOD,risk_model$SCHEDULE_PROBHIGH)
performance_values = c(risk_model$OUTCOME_PROBOPP,risk_model$OUTCOME_PROBLOW,risk_model$OUTCOME_PROBMOD,risk_model$OUTCOME_PROBHIGH)
monte_pies = data.frame(ranking,colors, round(cost_values,2), round(schedule_values,2),round(performance_values,2))
names(monte_pies) = c("ranking", "colors","cost_values", "schedule_values","performance_values")
cost_label <- monte_pies |>
  slice_max(cost_values)|>
  select(ranking,colors)
schedule_label <- monte_pies|>
  slice_max(schedule_values)|>
  select(ranking,colors)
performance_label <- monte_pies|>
  slice_max(performance_values)|>
  select(ranking, colors)


monte_pie<-plot_ly() |>
  add_pie(
    monte_pies,
    value = ~monte_pies$cost_values,
    labels =~monte_pies$ranking,
    title = list(text = paste(cost_label$ranking),
                 font= list(size = 13, color=cost_label$colors)),
    textinfo = 'none',
    hoverinfo = 'label+percent',
    name = " ",
    marker = list(colors = ~monte_pies$colors),
    domain = list(row = 0, column = 0),
    hole = 0.7
  ) |>
  layout(annotations = list(
      x = c(0.12, 0.10),
      y = c(1.2,-0.15),
      xref = "paper",
      yref = "paper",
      showarrow = F,
      text = c("Cost",paste("Mean:",
                            formattable::currency(risk_model$COST_MEAN,digits = 0)))))|>
  add_pie(
    monte_pies,
    value = ~monte_pies$schedule_values,
    labels =~monte_pies$ranking,
    title = list(text = paste(schedule_label$ranking),font = list(size = 13,color = schedule_label$colors)),
    textinfo = 'none',
    hoverinfo = 'label+percent',
    name = " ",
    domain = list(row = 0, column = 1),
    hole = 0.7,
    marker = list(colors = ~monte_pies$colors),
    legend=F
  )|>
  layout(annotations = list(x=c(0.49,0.485), y=c(1.2,-0.15), xref="paper", yref = "paper", showarrow = F,
                                                text = c("Schedule",paste("Mean:", risk_model$SCHEDULE_MEAN,"Days")))) |>
  add_pie(
    monte_pies,
    value = ~monte_pies$performance_values,
    labels =~monte_pies$ranking,
    title = list(text=paste(performance_label$ranking), font = list(size = 13,color = performance_label$colors)),
    textinfo = 'none',
    hoverinfo = 'label+percent',
    name = " ",
    domain = list(row = 0, column = 2),
    hole = 0.7,
    marker = list(colors = ~monte_pies$colors),
    legend=F
  )|>
  layout(annotations = list(x=c(0.9), y=c(1.2), xref ="paper", yref="paper",showarrow = F,text = c("Performance")))

  pies<-monte_pie |>
    plotly::layout(title = "",
                    showlegend = F,
      margin=list(l=20,r=20,b=20, t=25, pad=0),
                   grid=list(rows=1, columns=3),
           showlegend=F)
  pies
```
</center>
###### **Event Likelihood:** `r risk_item$LIKELIHOOD_DESC`
`r risk_item$PROB_OCCURRENCE_EVIDENCE`
```{r Risk Item table, echo=FALSE, results='asis'}
risk_item_table <- risk_item |>
  select(
    NO_COST_IMPACT,
    NO_SCHEDULE_IMPACT,
    NO_PERFORMANCE_IMPACT,
    COST_IMPACT_MOSTLIKELY,
    SCHEDULE_IMPACT_MOSTLIKELY,
    COST_IMPACT_LOWEST,
    COST_IMPACT_HIGHEST,
    COST_IMPACT_EVIDENCE,
    SCHEDULE_IMPACT_LOWEST,
    SCHEDULE_IMPACT_HIGHEST,
    SCHEDULE_IMPACT_EVIDENCE,
    PERFORMANCE_IMPACT_DESC,
    PERFORMANCEIMPACT,
    PERFORMANCEIMPACT_DESC,
    SCHEDULE_IMPACT_DISTTYPE,
    COST_IMPACT_DISTTYPE
  ) |>
  mutate(
    COST_IMPACT_LOWEST = paste0("<p style = 
                                'font-family: Arial Narrow;font-size:8pt'>",
                                "Lowest","</p>", 
                                formattable::currency(COST_IMPACT_LOWEST)),
    COST_IMPACT_HIGHEST = paste0("<p style = 
                                'font-family: Arial Narrow;font-size:8pt'>",
                                "Highest","</p>",
                                 formattable::currency(COST_IMPACT_HIGHEST)),
    COST_IMPACT_MOSTLIKELY = paste0("<p style = 
                                    'font-family: Arial Narrow;font-size:8pt'>",
                                    "Most Likely","</p>", 
                                    formattable::currency(COST_IMPACT_MOSTLIKELY)),
    SCHEDULE_IMPACT_HIGHEST = paste0("<p style = 
                                     'font-family: Arial Narrow;font-size:8pt'>",
                                     "Highest","</p>",
                                     SCHEDULE_IMPACT_HIGHEST, " days"),
    SCHEDULE_IMPACT_LOWEST = paste0("<p style = 
                                    'font-family: Arial Narrow;font-size:8pt'>",
                                    "Lowest","</p>",
                                    SCHEDULE_IMPACT_LOWEST, " days"),
    SCHEDULE_IMPACT_MOSTLIKELY = paste0("<p style = 
                                        'font-family: Arial Narrow;font-size:8pt'>",
                                        "Most Likely","</p>",
                                        SCHEDULE_IMPACT_MOSTLIKELY, " days"),
    PERFORMANCE_IMPACT_DESC = paste0("<p style = 
                                        'font-family: Arial;font-size:8pt; 
                                     font-weight: bold'>",
                                        "Performance Impact:","</p>",
                                        PERFORMANCE_IMPACT_DESC, " to ", 
                                     PERFORMANCEIMPACT),
    PERFORMANCEIMPACT = paste0("<p style = 
                                        'font-family: Arial;font-size:8pt;
                               font-weight: bold'>",
                                        "Performance Impact Type:","</p>",
                                        PERFORMANCEIMPACT),
    PERFORMANCEIMPACT_DESC = paste0("<p style = 
                                        'font-family: Arial;font-size:8pt;
                               font-weight: bold'>",
                                        "Performance Impact Description:","</p>",
                                        PERFORMANCEIMPACT_DESC)
  )
```



####Modularize assess for each cost schedule and performance build function
```{r Creating Risk Table Columns, echo=FALSE, results='asis'}
costcolumn <-
  if (risk_item_table$NO_COST_IMPACT == 1) {
    c("No cost impact is anticipated","","","")
  } else if(risk_item_table$COST_IMPACT_DISTTYPE == 299){
     c(risk_item_table$COST_IMPACT_MOSTLIKELY,
      "",
      "",
      "")
  } else if (risk_item_table$COST_IMPACT_DISTTYPE == 306) {
    c(
      risk_item_table$COST_IMPACT_LOWEST,
      "",
      risk_item_table$COST_IMPACT_HIGHEST,
      risk_item_table$COST_IMPACT_EVIDENCE
    )
  } else if (risk_item_table$COST_IMPACT_DISTTYPE == 302) {
    c(
      risk_item_table$COST_IMPACT_LOWEST,
      risk_item_table$COST_IMPACT_MOSTLIKELY,
      risk_item_table$COST_IMPACT_HIGHEST,
      risk_item_table$COST_IMPACT_EVIDENCE
    )
  }
```


```{r schedule column, echo=FALSE, results='asis'}
schedulecolumn <-
  if (risk_item_table$NO_SCHEDULE_IMPACT == 1) {
    c("No schedule impact is anticipated","","","")
  } else if (risk_item_table$SCHEDULE_IMPACT_DISTTYPE == 299) {
    c(risk_item_table$SCHEDULE_IMPACT_MOSTLIKELY,"","","")
  } else if (risk_item_table$SCHEDULE_IMPACT_DISTTYPE == 306) {
    c(
      risk_item_table$SCHEDULE_IMPACT_LOWEST,
      "",
      risk_item_table$SCHEDULE_IMPACT_HIGHEST,
      risk_item_table$SCHEDULE_IMPACT_EVIDENCE
    )
  } else if (risk_item_table$SCHEDULE_IMPACT_DISTTYPE == 302) {
    c(
      risk_item_table$SCHEDULE_IMPACT_LOWEST,
      risk_item_table$SCHEDULE_IMPACT_MOSTLIKELY,
      risk_item_table$SCHEDULE_IMPACT_HIGHEST,
      risk_item_table$SCHEDULE_IMPACT_EVIDENCE
    )
  }

```



```{r performance column, echo=FALSE, results='asis'}
performancecolumn <-
  if (risk_item_table$NO_PERFORMANCE_IMPACT == 1) {
    c("No performance impact is anticipated","","","")
  } else {
    c(
      risk_item_table$PERFORMANCE_IMPACT_DESC,
      risk_item_table$PERFORMANCEIMPACT,
      risk_item_table$PERFORMANCEIMPACT_DESC,
      ""
    )
  }


disttable<-data.frame(costcolumn, schedulecolumn,performancecolumn)
disttable[is.na(disttable)] <- ""

kable(disttable,format = "html", escape=FALSE, col.names=c("Cost Impact",
                                                            "Schedule Impact",
                                                            "Performance Impact"))|>
  kable_styling()




```
`r if(!treat_condit){"Risk treatments have not been completed for this risk item"}`
```{r echo = FALSE, message = FALSE, eval = treat_condit}
risk_treat_table<-risk_treatment |>
  select(RISK_TREATMENT_ID,PROPOSED_RISK_TREATMENT,COST_IMPACT_RISK_TREATMENT,
         SCHEDULE_IMPACT_RISK_TREATMENT, IMPLEMENTED, RISK_NAME) |>
  mutate(IMPLEMENT_IMG = case_when(
    IMPLEMENTED == 1 ~ checkimagepath,
    IMPLEMENTED == 0 ~ " ")) |>
  select(RISK_TREATMENT_ID,PROPOSED_RISK_TREATMENT,COST_IMPACT_RISK_TREATMENT,
         SCHEDULE_IMPACT_RISK_TREATMENT, IMPLEMENT_IMG) |>
  mutate(PROPOSED_RISK_TREATMENT = paste0(( "Measure "), 
                                          str_to_title(english::english(
                                            RISK_TREATMENT_ID)),": ",
                                          PROPOSED_RISK_TREATMENT )) |>
  mutate(SCHEDULE_IMPACT_RISK_TREATMENT = 
           paste(SCHEDULE_IMPACT_RISK_TREATMENT, "Days"))

risk_treat_table$IMPLEMENT_IMG = sprintf("![    ](%s)",
risk_treat_table$IMPLEMENT_IMG)


kbl(
risk_treat_table,
format = "html",
col.names = NULL,
align = "llccc"
) |>
kable_styling() |>
add_header_above(c(
"Measures" = 2,
"Impacts" = 2,
"Implemented" = 1
))


```

```{r risk log, echo = FALSE, warning=FALSE, eval= FALSE}
risk_log<-data.frame(risk_transact)
risk_log<-risk_log %>%
  mutate('costcolor' = case_when(COST_RISK_RANKING == 0 ~ '#ffffff',
  COST_RISK_RANKING == 1 ~ '#1F78B4',
  COST_RISK_RANKING == 2 ~'#33A02C', 
  COST_RISK_RANKING == 3 ~'#FF7F00',
  COST_RISK_RANKING ==  4 ~ '#E31A1C')) %>%
  mutate('schedulecolor' = case_when(SCHEDULE_RISK_RANKING == 0 ~ '#ffffff',
  SCHEDULE_RISK_RANKING == 1 ~ '#1F78B4',
  SCHEDULE_RISK_RANKING == 2 ~'#33A02C', 
  SCHEDULE_RISK_RANKING == 3 ~'#FF7F00',
  SCHEDULE_RISK_RANKING ==  4 ~ '#E31A1C')) %>%
  mutate('performancecolor' = case_when(PERFORMANCEIMPACT_RISK_RANKING == 0 ~ '#ffffff',
  PERFORMANCEIMPACT_RISK_RANKING == 1 ~ '#1F78B4',
  PERFORMANCEIMPACT_RISK_RANKING == 2 ~'#33A02C', 
  PERFORMANCEIMPACT_RISK_RANKING == 3 ~'#FF7F00',
  PERFORMANCEIMPACT_RISK_RANKING == 4 ~ '#E31A1C'))%>%
  mutate(TREAT_IMPLEMENT_IMG = if_else(is.na(treat_condit), "", checkimagepath))
         

risk_log_table<-risk_log |>
  select(DATE_TIME, REASON, RISK_LOG_NOTE, TREAT_IMPLEMENT_IMG, COST_RISK_RANKING, SCHEDULE_RISK_RANKING, PERFORMANCEIMPACT_RISK_RANKING, costcolor, schedulecolor, performancecolor )

risk_log_table$TREAT_IMPLEMENT_IMG = sprintf("![](%s)", risk_log_table$TREAT_IMPLEMENT_IMG)
risk_log_table[1:10]|>
  mutate(
    COST_RISK_RANKING = cell_spec(COST_RISK_RANKING, "html", color = costcolor, align = 'c', background = costcolor),
    SCHEDULE_RISK_RANKING = cell_spec(SCHEDULE_RISK_RANKING, "html", color = schedulecolor, align = 'c', background = schedulecolor),
      PERFORMANCEIMPACT_RISK_RANKING = cell_spec(PERFORMANCEIMPACT_RISK_RANKING, "html", color = performancecolor, align = 'c', background = performancecolor) ) |>
  select(DATE_TIME, REASON,RISK_LOG_NOTE, TREAT_IMPLEMENT_IMG, COST_RISK_RANKING, SCHEDULE_RISK_RANKING, PERFORMANCEIMPACT_RISK_RANKING) |>
  kbl(format = "html", escape = F, col.names =c("Edit Date", "Reason for Change", "Risk Log Note",  "Measures Implemented", "Cost","Schedule","Performance"), align="lllcccc")|>
  kable_styling(bootstrap_options = c("condensed"))

                                                    
```

###### Risk Manager: `r risk_item$RISK_MANAGER`

