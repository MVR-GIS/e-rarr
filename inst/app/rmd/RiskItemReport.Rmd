---
title: ""
output: html_document
params:
  riskID: Preliminary Design
  projID: Biscayne Bay Coastal Wetlands (BBCW)
  p2ID: 	113846
  shinyrend: FALSE
---

```{css, echo=FALSE}
h1 {
  text-align: center;
}

th {    vertical-align: top;    
    white-space: nowrap;
    padding: 10px;
    
}

td {    vertical-align: top;
  padding: 10px;
}
}
```

```{r echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library(readr) 
library(magrittr) 
library(dplyr) 
library(kableExtra) 
library(rlang)
library(plotly)
library(ggplot2)
library(ggrepel)
library(dplyr)
library(knitr)
library(crosstalk)
library(tidyverse)
library(english)
library(DT)
library(webshot)
library(erarr)
options(scipen = 999)
erisk_item <- readr::read_csv("../data/RISKLIST_FULL.csv")
risk_item_db<-data.frame(erisk_item)
erisk_project <- readr::read_csv("../data/PROJECTLIST_FULL.csv")
risk_project_db<-data.frame(erisk_project)
risk_treat <- readr::read_csv("../data/RISKTREATMENTLIST_FULL.csv",
                              col_names = TRUE)
checkimagepath<-"../www/check.png"
erisk_item <- readr::read_csv("../data/RISKLIST_FULL.csv")
risk_item_db<-data.frame(erisk_item)
milestonedf<-read.csv("../data/PHASEMILESTONE.csv")
milestone_df<-data.frame(milestonedf)
headers<-c("Cost Impact", "Schedule Impact","Performance Impact")

risk_transact <- read_csv("../data/RISKTRANSACTIONLIST_FULL.csv")

erisk_ItemProj<-left_join(risk_item_db, risk_project_db, by = "PROJECT_ID")                                                                                                                          
risk_item_filt<- risk_item_db |>
  select(RISK_ID, PROJECT_ID, RISK_NAME , PROJECT_NAME, P2_NUMBER)



RiskImpactTable<-erisk_ItemProj |>
  select("RISK_ID","RISK_IDENTIFIER","P2_NUMBER.x", "PROJECT_ID",
         "PROJECT_NAME.x", "RISK_NAME","RISKCATEGORY", "DISCIPLINE", 
         "RISK_STATEMENT","LIKELIHOOD_DESC", "PROB_OCCURRENCE_EVIDENCE",  
         "COST_IMPACT_LOWEST", "COST_IMPACT_MOSTLIKELY", "COST_IMPACT_HIGHEST",
         "COST_IMPACT_EVIDENCE","SCHEDULE_IMPACT_LOWEST", 
         "SCHEDULE_IMPACT_MOSTLIKELY", "SCHEDULE_IMPACT_HIGHEST", 
         "SCHEDULE_IMPACT_EVIDENCE", "LIFECYCLEPHASENAME.x", 
         "PERFORMANCEIMPACT_DESC", "PERFORMANCEIMPACT" ,"PROJECTPHASEID", 
         "MILESTONE", "RISK_MANAGER", "COST_IMPACT_DISTTYPE", 
         "SCHEDULE_IMPACT_DISTTYPE", "NO_PERFORMANCE_IMPACT", "NO_COST_IMPACT",
         "NO_SCHEDULE_IMPACT")

risk_transact<-left_join(risk_transact, risk_item_filt, by=c("PROJECT_ID", 
                                                             "RISK_ID"))     
risk_treat<-left_join(risk_treat, risk_item_filt, by=c("PROJECT_ID", "RISK_ID"))



```

```{r echo=FALSE}
if (params$shinyrend)
  shiny::setProgress(0.25)  # set progress to 25%
```

```{r echo=FALSE, eval = params$projID != ""}
risk_item<-filter(RiskImpactTable, RiskImpactTable$RISK_NAME == params$riskID,
                  RiskImpactTable$PROJECT_NAME.x == params$projID)
risk_treatment<-filter(risk_treat, risk_treat$PROJECT_NAME == params$projID, 
                       risk_treat$RISK_NAME == params$riskID)

```

```{r echo=FALSE, eval = params$p2ID != ""}
risk_item<-filter(RiskImpactTable, RiskImpactTable$RISK_NAME == params$riskID, 
                  RiskImpactTable$P2_NUMBER == params$p2ID)
risk_treatment<-filter(risk_treat, risk_treat$PROJECT_NAME == params$projID, 
                       risk_treat$RISK_NAME == params$riskID)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
risk_treat_table<-risk_treatment |>
  select(RISK_TREATMENT_ID,PROPOSED_RISK_TREATMENT,COST_IMPACT_RISK_TREATMENT,
         SCHEDULE_IMPACT_RISK_TREATMENT, IMPLEMENTED, RISK_NAME) |>
  mutate(IMPLEMENT_IMG = case_when(
    IMPLEMENTED == 1 ~ checkimagepath,
    IMPLEMENTED == 0 ~ " ")) |>
  select(RISK_TREATMENT_ID,PROPOSED_RISK_TREATMENT,COST_IMPACT_RISK_TREATMENT,
         SCHEDULE_IMPACT_RISK_TREATMENT, IMPLEMENT_IMG) |>
  mutate(PROPOSED_RISK_TREATMENT = paste0(( "Measure "), 
                                          str_to_title(english::english(
                                            RISK_TREATMENT_ID)),": ",
                                          PROPOSED_RISK_TREATMENT )) |>
  mutate(SCHEDULE_IMPACT_RISK_TREATMENT = 
           paste(SCHEDULE_IMPACT_RISK_TREATMENT, "Days"))

treat_condit <- ifelse(nrow(risk_treat_table)>0,TRUE,FALSE)

  
```

#### Project: `r risk_item$PROJECT_NAME.x`

#### Risk Phase: `r risk_item$LIFECYCLEPHASENAME`, Category:

`r risk_item$RISKCATEGORY`

# Risk Summary: `r risk_item$RISK_NAME`

```{r milestoneplot, fig.align='center', fig.height=2, fig.width=9, echo=FALSE}
erarr::milestoneplot(riskitem=risk_item, milestonedf = milestone_df)

```

```{r echo=FALSE}
if (params$shinyrend)
  shiny::setProgress(0.50)  # set progress to 50%
```

##### **Lead Discipline:** `r risk_item$DISCIPLINE`

##### `r risk_item$RISK_STATEMENT`

<center>

```{r echo=F, out.width="75%", fig.height=2}
monteframe <- data.frame(Opportunity = c(100), Low = c(100))
plot_ly() |>
  add_pie(
    monteframe$Opportunity,
    value = monteframe$Opportunity,
    title = "Opportunity",
    textinfo = 'none',
    domain = list(row = 0, column = 0),
    hole = 0.7,
    marker = list(colors = "#1F78B4")
  ) |>
  add_pie(
    monteframe$Opportunity,
    value = monteframe$Opportunity,
    title = "Opportunity",
    textinfo = 'none',
    domain = list(row = 0, column = 1),
    hole = 0.7,
    marker = list(colors = "#1F78B4")
  ) |>
  add_pie(
    monteframe$Low,
    value = monteframe$Low,
    title = "Low",
    textinfo = 'none',
    domain = list(row = 0, column = 2),
    hole = 0.7,
    marker = list(colors = "#33A02C")
  ) |>
  layout(
    title = "",
    showlegend = F,
    grid = list(rows = 1, columns = 3),
    annotations = list(
      x = c(0.125, 0.49, 0.9, 0.12, 0.485),
      y = c(1.2, 1.2, 1.2, -0.15,-0.15),
      text = c("Cost", "Schedule", "Performance", "Mean: $0",
               "Mean: 0 Days"),
      xref = "paper",
      yref = "paper",
      showarrow = F
    )
  )


```

</center>

```{r echo=FALSE}
if (params$shinyrend)
  shiny::setProgress(0.75)  # set progress to 75%
```

#### **Event Likelihood:** `r risk_item$LIKELIHOOD_DISC`

#### `r risk_item$PROB_OCCURRENCE_EVIDENCE`

```{r echo=FALSE, results='asis'}
risk_item_table <- risk_item |>
  select(
    NO_COST_IMPACT,
    NO_SCHEDULE_IMPACT,
    NO_PERFORMANCE_IMPACT,
    COST_IMPACT_MOSTLIKELY,
    SCHEDULE_IMPACT_MOSTLIKELY,
    COST_IMPACT_LOWEST,
    COST_IMPACT_HIGHEST,
    COST_IMPACT_EVIDENCE,
    SCHEDULE_IMPACT_LOWEST,
    SCHEDULE_IMPACT_HIGHEST,
    SCHEDULE_IMPACT_EVIDENCE,
    PERFORMANCEIMPACT_DESC,
    PERFORMANCEIMPACT,
    PERFORMANCEIMPACT_DESC,
    SCHEDULE_IMPACT_DISTTYPE,
    COST_IMPACT_DISTTYPE
  ) |>
  mutate(
    COST_IMPACT_LOWEST = paste0("<p style = 
                                'font-family: Arial Narrow;font-size:8pt'>",
                                "Lowest","</p>", 
                                formattable::currency(COST_IMPACT_LOWEST)),
    COST_IMPACT_HIGHEST = paste0("<p style = 
                                'font-family: Arial Narrow;font-size:8pt'>",
                                "Highest","</p>",
                                 formattable::currency(COST_IMPACT_HIGHEST)),
    COST_IMPACT_MOSTLIKELY = paste0("<p style = 
                                    'font-family: Arial Narrow;font-size:8pt'>",
                                    "Most Likely","</p>", 
                                    formattable::currency(COST_IMPACT_MOSTLIKELY)),
    SCHEDULE_IMPACT_HIGHEST = paste0("<p style = 
                                     'font-family: Arial Narrow;font-size:8pt'>",
                                     "Highest","</p>",
                                     SCHEDULE_IMPACT_HIGHEST, " days"),
    SCHEDULE_IMPACT_LOWEST = paste0("<p style = 
                                    'font-family: Arial Narrow;font-size:8pt'>",
                                    "Lowest","</p>",
                                    SCHEDULE_IMPACT_LOWEST, " days"),
    SCHEDULE_IMPACT_MOSTLIKELY = paste0("<p style = 
                                        'font-family: Arial Narrow;font-size:8pt'>",
                                        "Most Likely","</p>",
                                        SCHEDULE_IMPACT_MOSTLIKELY, " days")
  )

####Modularize assess for each cost schedule and performance build function

costcolumn <-
  if (risk_item_table$NO_COST_IMPACT == 1) {
    "No cost impact is anticipated"
  } else if (risk_item_table$COST_IMPACT_DISTTYPE == 299) {
    risk_item_table$COST_IMPACT_MOSTLIKELY
  } else if (risk_item_table$COST_IMPACT_DISTTYPE == 306) {
    c(
      risk_item_table$COST_IMPACT_LOWEST,
      risk_item_table$COST_IMPACT_HIGHEST,
      risk_item_table$COST_IMPACT_EVIDENCE
    )
  } else if (risk_item_table$COST_IMPACT_DISTTYPE == 302) {
    c(
      risk_item_table$COST_IMPACT_LOWEST,
      risk_item_table$COST_IMPACT_MOSTLIKELY,
      risk_item_table$COST_IMPACT_HIGHEST,
      risk_item_table$COST_IMPACT_EVIDENCE
    )
  }

schedulecolumn <-
  if (risk_item_table$NO_PERFORMANCE_IMPACT == 1) {
    "No performance impact is anticipated"
  } else if (risk_item_table$SCHEDULE_IMPACT_DISTTYPE == 299) {
    risk_item_table$SCHEDULE_IMPACT_MOSTLIKELY
  } else if (risk_item_table$SCHEDULE_IMPACT_DISTTYPE == 306) {
    c(
      risk_item_table$SCHEDULE_IMPACT_LOWEST,
      risk_item_table$SCHEDULE_IMPACT_HIGHEST,
      risk_item_table$SCHEDULE_IMPACT_EVIDENCE
    )
  } else if (risk_item_table$SCHEDULE_IMPACT_DISTTYPE == 302) {
    c(
      risk_item_table$SCHEDULE_IMPACT_LOWEST,
      risk_item_table$SCHEDULE_IMPACT_MOSTLIKELY,
      risk_item_table$SCHEDULE_IMPACT_HIGHEST,
      risk_item_table$SCHEDULE_IMPACT_EVIDENCE
    )
  }

performancecolumn <-
  if (risk_item_table$NO_PERFORMANCE_IMPACT == 1) {
    "No performance impact is anticipated"
  } else {
    c(
      risk_item_table$PERFORMANCEIMPACT_DESC,
      risk_item_table$PERFORMANCEIMPACT,
      risk_item_table$PERFORMANCEIMPACT_DESC
    )
  }






knitr::kables(
  list(
    knitr::kable(costcolumn,
                 format = "html",
                 col.names = "Cost Impact",escape=FALSE) |>
       kable_styling(),
    knitr::kable(schedulecolumn,
                 format = "html",
                 col.names = "Schedule Impact",escape=FALSE) |>
       kable_styling(),

    knitr::kable(performancecolumn,
                 format = "html",
                 col.names = "Performance Impact",escape=FALSE) |>
       kable_styling()
  )
)


```

#### Risk Treatments:

`r if(!treat_condit){"Risk treatments have not been completed for this risk item"}`

```{r echo = FALSE, message = FALSE, eval = treat_condit}
risk_treat_table$IMPLEMENT_IMG = sprintf("![    ](%s)",
risk_treat_table$IMPLEMENT_IMG)


kbl(
risk_treat_table,
format = "html",
col.names = NULL,
align = "llccc"
) |>
kable_styling() |>
add_header_above(c(
"Measures" = 2,
"Impacts" = 2,
"Implemented" = 1
))


```

##### Risk Manager: `r risk_item$RISK_MANAGER`

```{r echo = FALSE}
if (params$shinyrend)
shiny::setProgress(.95)  # set progress to 95%
```
