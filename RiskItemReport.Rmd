
```{r, include=FALSE, echo=FALSE, warning = FALSE}
library(readr) 
library(magrittr) 
library(dplyr) 
library(kableExtra) 
library(rlang)
library(plotly)
library(ggplot2)
library(ggrepel)
library(dplyr)
library(crosstalk)
library(tidyverse)
library(leaflet)
library(DT)
erisk_item <- read_csv("data/RiskItem_FullView_Update.csv")
risk_item_db<-data.frame(erisk_item)
erisk_project <- read_csv("data/RiskProject_FullView.csv")
risk_project_db<-data.frame(erisk_project)
risk_treat <- read_csv("data/RiskTreatment_FullView.csv")
imagepath<-"C:/workspace/e-rarr/images/check.png"

erisk_ItemProj<-left_join(risk_item_db, risk_project_db, by = "PROJECT_ID")

erisk_testing<-erisk_ItemProj[,c(3,5,6,8,22,27,32,40,51,56,64,65)]

RiskImpactTable<-erisk_ItemProj[,c(1,2,3,6,17,9,12,13,26,27,28,29,30,31,32,33,23,22,42,48,49,50,51,52)]


risk_item<-filter(RiskImpactTable, RiskImpactTable$RISK_ID == 7, RiskImpactTable$PROJECT_ID == 3069)
risk_treatment<-filter(risk_treat, risk_treat$PROJECT_ID == 3069, risk_treat$RISK_ID == 7)

risk_item_table<- risk_item %>%
  select(COST_IMPACT_LOWEST,COST_IMPACT_HIGHEST, COST_IMPACT_EVIDENCE,SCHEDULE_IMPACT_LOWEST, SCHEDULE_IMPACT_HIGHEST, SCHEDULE_IMPACT_EVIDENCE,PERFORMANCEIMPACT_DESC, PERFORMANCEIMPACTTYPE, PERFORMANCEIMPACT_DESC, SCHEDULE_IMPACT_DISTTYPE)


risk_treat_table<-risk_treatment %>%
  select(RISK_TREATMENT_ID,PROPOSED_RISK_TREATMENT,COST_IMPACT_RISK_TREATMENT,
         SCHEDULE_IMPACT_RISK_TREATMENT, IMPLEMENTED) %>%
  mutate(IMPLEMENT_IMG = case_when(
    IMPLEMENTED == 1 ~ imagepath,
    IMPLEMENTED == 0 ~ "")) %>%
  select(RISK_TREATMENT_ID,PROPOSED_RISK_TREATMENT,COST_IMPACT_RISK_TREATMENT,
         SCHEDULE_IMPACT_RISK_TREATMENT, IMPLEMENT_IMG)

    
```

# Risk Summary: `r risk_item$RISK_NAME`

```{r, milestoneplot, echo=FALSE, warning=FALSE, out.height= "15%", fig.align='center'}
mockdf<- data.frame(ID = c("Project Initiation","Identify Alternatives","Tentatively Selected Plan","Agency Decision","Senior Leaders Briefing","Chief's Report/Director's Report"),
                    yval = c(0.15,0.15,0.15,0.15,0.15,0.15),
                    xval = c(1,2,3,4,5,6))
mockdf$xwrap = str_wrap(mockdf$ID, width=10)
level_order<-c('Project Initiation','Identify Alternatives','Tentatively Selected Plan','Agency Decision','Senior Leaders Briefing',"Chief's Report/Director's Report")


ggplot(mockdf, aes(x=factor(ID, level=c(level_order)), y=yval))+
  geom_segment(x=1, y = 0.15, xend = 6, yend = 0.15, size=1.5, color = "grey")+
  geom_point(size=8,color="grey", fill="snow1", shape=21, stroke=1.5)+
  geom_point(aes(x=risk_item$MILESTONE, y=0.15), colour="deepskyblue2", fill="deepskyblue2", shape = 21, size =8, stroke=1.5)+
  #geom_text_repel(aes(label=xwrap, color="red"), position="nudge")+
  geom_label(label=mockdf$xwrap,nudge_y=1, )+
  scale_y_continuous(expand=c(0,0))+
  coord_cartesian(ylim=c(0.15,0.15))+
   theme_void()
  # theme(line = element_blank(),
  #       title = element_blank(),
  #       axis.text.y = element_blank(),
  #       axis.text.x = element_blank(),
  #       axis.ticks.length = unit(0, "pt"),
  #       panel.background = element_blank(), 
  #       plot.margin=unit(c(0,0,0,0),"cm"))


```

```{r , echo=FALSE, fig.align='center' }
knitr::include_graphics("C:/workspace/e-rarr/images/montecarlo.png")
```

### Lead Discipline: `r risk_item$DISCIPLINE`

#### `r risk_item$RISK_STATEMENT`

## Event Likelihood: `r risk_item$LIKELIHOOD_DISC`

`r risk_item$PROB_OCCURRENCE_EVIDENCE`

| Cost Impact                                   | Schedule Impact                                      | Performance Impact                                                 |
|--------------------|-----------------------|-----------------------------|
| *Lowest* \$`r risk_item$COST_IMPACT_LOWEST`   | *Lowest* `r risk_item$SCHEDULE_IMPACT_LOWEST` days   | ***Performance Impact:*** `r risk_item$PERFORMANCEIMPACT_DESC`     |
| *Highest* \$`r risk_item$COST_IMPACT_HIGHEST` | *Highest* `r risk_item$SCHEDULE_IMPACT_HIGHEST` days | ***Performance Impact Type:*** `r risk_item$PERFORMANCEIMPACTTYPE` |
| `r risk_item$COST_IMPACT_EVIDENCE`            | `r risk_item$SCHEDULE_IMPACT_EVIDENCE`               | `r risk_item$PERFORMANCEIMPACT_DESC`                               |

## Risk Treatments

```{r, echo=FALSE}
risk_treat_table$IMPLEMENT_IMG = sprintf("![](%s)", risk_treat_table$IMPLEMENT_IMG)
kbl(risk_treat_table,"html",col.names = NULL) %>%
  add_header_above(c("Measures"=2, "Impacts" = 2,"Implemented" = 1))


```

```{r, include=FALSE, echo=FALSE, warning = FALSE}
risk_transact <- read_csv("data/RiskTransaction_FullView.csv")
risk_log<-data.frame(risk_transact)
risk_log<-risk_log %>%
  mutate('costcolor' = case_when(COST_RISK_RANKING == 0 ~ 'deepskyblue',
  COST_RISK_RANKING ==1 ~'green', 
  COST_RISK_RANKING == 2 ~'orange',
  COST_RISK_RANKING ==  3 ~ 'red')) %>%
  mutate('schedulecolor' = case_when(SCHEDULE_RISK_RANKING == 0 ~ 'deepskyblue',
  SCHEDULE_RISK_RANKING ==1 ~'green', 
  SCHEDULE_RISK_RANKING == 2 ~'orange',
  SCHEDULE_RISK_RANKING ==  3 ~ 'red')) %>%
  mutate('performancecolor' = case_when(PERFORMANCEIMPACT_RISK_RANKING == 0 ~ 'deepskyblue',
  PERFORMANCEIMPACT_RISK_RANKING ==1 ~'green', 
  PERFORMANCEIMPACT_RISK_RANKING == 2 ~'orange',
  PERFORMANCEIMPACT_RISK_RANKING ==  3 ~ 'red'))%>%
  mutate(TREAT_IMPLEMENT_IMG = if_else(is.na(TREATMENTS_IMPLEMENTED), NA, imagepath))
         
         
risk_item_log<-filter(risk_log, RISK_ID == 7, PROJECT_ID == 3069)
risk_log_table<-risk_item_log %>%
  select(DATE_TIME, REASON, RISK_LOG_NOTE, TREAT_IMPLEMENT_IMG, COST_RISK_RANKING, SCHEDULE_RISK_RANKING, PERFORMANCEIMPACT_RISK_RANKING, costcolor, schedulecolor, performancecolor )
```

## Risk Log: 
```{r, echo=FALSE}
risk_log_table$TREAT_IMPLEMENT_IMG = sprintf("![](%s)", risk_log_table$TREAT_IMPLEMENT_IMG)
risk_log_table[1:7]%>%
kbl("html", col.names =c("Edit Date", "Reason for Change", "Risk Log Note",  "Measures Implemented", "Cost","Schedule","Performance")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>%
  column_spec(5,color="black", background=risk_log_table$costcolor)%>%
  column_spec(6,color="black", background=risk_log_table$schedulecolor)%>%
  column_spec(7,color="black", background=risk_log_table$performancecolor)

                                                    
```

