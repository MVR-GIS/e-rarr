---
output:
  html_document: default
  pdf_document: default
  always_allow_html: true
---

```{r pull data from api, include=FALSE}
library(httr) # handles GET requests through the API
library(jsonlite) # Converts JSON input to df and readable output
library(writexl) 

# add useful functions
make_URL <- function(children) {
  return(paste("https://err.sec.usace.army.mil", children, sep=""))
}

make_headers <- function(token, userSpec) {
  return(httr::add_headers(c('Accept'="application/json, text/plain, */*", 'Authorization'=paste('Bearer', token), 'Access-Control-Allow-Methods'='GET'), 'user'=userSpec))
}

#api/vocabulary

  header <- make_headers(token, userSpec)
  accURL <- make_URL("/api/vocabulary")
  data = httr::GET(accURL, header)
  apiVocab = jsonlite::fromJSON(rawToChar(data$content))

  
  header <- make_headers(token, userSpec)
  accURL <- make_URL("/api/help")
  data = httr::GET(accURL, header)
  apihelp = jsonlite::fromJSON(rawToChar(data$content))
  writexl::write_xlsx(data.frame(apihelp$rows), "excelOutput\\New Files\\apiHelp.xlsx")
  
  apihelp$rows
  
    helpID <- "rr_1"
  header <- make_headers(token, userSpec)
  accURL <- make_URL(paste("/api/help/", helpID, sep=""))
  helpID = httr::GET(accURL, header)
  helpID = jsonlite::fromJSON(rawToChar(helpID$content))
  #writexl::write_xlsx(data.frame(apihelp$rows), "excelOutput\\New Files\\apiHelp.xlsx")
  
  helpID$rows
  # not much useful info here

#/api/userinfo/{name}
  name <- 'benac.ryan.j.1613988200'
  header <- make_headers(token, userSpec)
  accURL <- make_URL(paste("/api/userinfo/", name, sep=""))
  userinfo = httr::GET(accURL, header)
  
#/api/projects
  apiSpec <- "/api/projects"
  header <- make_headers(token, userSpec)
  accURL <- make_URL(apiSpec)
  projects = httr::GET(accURL, header)
  projects = jsonlite::fromJSON(rawToChar(projects$content))
  writexl::write_xlsx(data.frame(projects$rows), "excelOutput\\New Files\\projects.xlsx")

  projects$rows

#/api/projects/{id}
   projectID <- 115
  apiSpec <- paste("/api/projects/", projectID, sep="")
  header <- make_headers(token, userSpec)
  accURL <- make_URL(apiSpec)
  projectID = httr::GET(accURL, header)
  projectID = jsonlite::fromJSON(rawToChar(projectID$content))
  writexl::write_xlsx(data.frame(projectID$rows), "excelOutput\\New Files\\projectID115.xlsx")

  projectID$rows

#/api/projects/{id}/projectphases
  projectID <- 115
  apiSpec <- paste("/api/projects/", projectID, "/projectphases", sep="")
  header <- make_headers(token, userSpec)
  accURL <- make_URL(apiSpec)
  projectphases = httr::GET(accURL, header)
  projectphases = jsonlite::fromJSON(rawToChar(projectphases$content))
  writexl::write_xlsx(data.frame(projectphases$rows), "excelOutput\\New Files\\projectID115_projectphases.xlsx")

  projectphases$rows

#/api/projects/{id}/users
   projectID <- 115
  apiSpec <- paste("/api/projects/", projectID, "/users", sep="")
  header <- make_headers(token, userSpec)
  accURL <- make_URL(apiSpec)
  users = httr::GET(accURL, header)
  users = jsonlite::fromJSON(rawToChar(users$content))
  writexl::write_xlsx(data.frame(users$rows), "excelOutput\\New Files\\projectID115_users.xlsx")

  users$rows
  
#/api/projects/{id}/risks
    projectID <- 3576
  apiSpec <- paste("/api/projects/", projectID, "/risks", sep="")
  header <- make_headers(token, userSpec)
  accURL <- make_URL(apiSpec)
  risks = httr::GET(accURL, header)
  risks = jsonlite::fromJSON(rawToChar(risks$content))
  writexl::write_xlsx(data.frame(risks$rows), "excelOutput\\New Files\\projectID3576_risks.xlsx")

  risks$rows

  
#/api/projects/{id}/risks/{riskid}/treatments

  projectID <- 3576
  riskID = 1

  apiSpec <- paste("/api/projects/", projectID, "/risks/", riskID, "/treatments",sep="")
  header <- make_headers(token, userSpec)
  accURL <- make_URL(apiSpec)
  treatments = httr::GET(accURL, header)
  treatments = jsonlite::fromJSON(rawToChar(treatments$content))
  writexl::write_xlsx(data.frame(treatments$rows), "excelOutput\\New Files\\project3576_riskTreatmentsHeaders.xlsx")

  treatments$metaData 

#/api/projects/{id}/risks/{riskid}/transactions
projectID <- 3576
  riskID = 1

  apiSpec <- paste("/api/projects/", projectID, "/risks/", riskID, "/transactions",sep="")
  header <- make_headers(token, userSpec)
  accURL <- make_URL(apiSpec)
  riskTransactions = httr::GET(accURL, header)
  riskTransactions = jsonlite::fromJSON(rawToChar(riskTransactions$content))
  writexl::write_xlsx(data.frame(riskTransactions$rows), "excelOutput\\New Files\\project3576_riskTransactions.xlsx")

  riskTransactions$rows  
```


```{r, include=FALSE, echo=FALSE, warning = FALSE}
library(readr) 
library(magrittr) 
library(dplyr) 
library(kableExtra) 
library(rlang)
library(plotly)
library(ggplot2)
library(ggrepel)
library(dplyr)
library(crosstalk)
library(tidyverse)
library(leaflet)
library(DT)
erisk_item <- read_csv("data/RiskItem_FullView_Update.csv")
risk_item_db<-data.frame(erisk_item)
erisk_project <- read_csv("data/RiskProject_FullView.csv")
risk_project_db<-data.frame(erisk_project)
risk_treat <- read_csv("data/RiskTreatment_FullView.csv")
imagepath<-"C:/workspace/e-rarr/images/check.png"

erisk_ItemProj<-left_join(risk_item_db, risk_project_db, by = "PROJECT_ID")

erisk_testing<-erisk_ItemProj[,c(3,5,6,8,22,27,32,40,51,56,64,65)]

RiskImpactTable<-erisk_ItemProj[,c(1,2,3,6,17,9,12,13,26,27,28,29,30,31,32,33,23,22,42,48,49,50,51,52)]


risk_item<-filter(RiskImpactTable, RiskImpactTable$RISK_ID == 7, RiskImpactTable$PROJECT_ID == 3069)
risk_treatment<-filter(risk_treat, risk_treat$PROJECT_ID == 3069, risk_treat$RISK_ID == 7)

risk_item_table<- risk_item %>%
  select(COST_IMPACT_LOWEST,COST_IMPACT_HIGHEST, COST_IMPACT_EVIDENCE,SCHEDULE_IMPACT_LOWEST, SCHEDULE_IMPACT_HIGHEST, SCHEDULE_IMPACT_EVIDENCE,PERFORMANCEIMPACT_DESC, PERFORMANCEIMPACTTYPE, PERFORMANCEIMPACT_DESC, SCHEDULE_IMPACT_DISTTYPE)


risk_treat_table<-risk_treatment %>%
  select(RISK_TREATMENT_ID,PROPOSED_RISK_TREATMENT,COST_IMPACT_RISK_TREATMENT,
         SCHEDULE_IMPACT_RISK_TREATMENT, IMPLEMENTED) %>%
  mutate(IMPLEMENT_IMG = case_when(
    IMPLEMENTED == 1 ~ imagepath,
    IMPLEMENTED == 0 ~ "")) %>%
  select(RISK_TREATMENT_ID,PROPOSED_RISK_TREATMENT,COST_IMPACT_RISK_TREATMENT,
         SCHEDULE_IMPACT_RISK_TREATMENT, IMPLEMENT_IMG)

    
```

# Risk Summary: `r risk_item$RISK_NAME`

```{r, milestoneplot, echo=FALSE, warning=FALSE,fig.height=1.75, fig.width=7, fig.align='center'}
mockdf<- data.frame(ID = c("Project Initiation","Identify Alternatives","Tentatively Selected Plan","Agency Decision","Senior Leaders Briefing","Chief's/Director's Report"),
                    yval = c(0.15,0.15,0.15,0.15,0.15,0.15),
                    xval = c(1,2,3,4,5,6))
mockdf$xwrap = str_wrap(mockdf$ID, width=14)
level_order<-c('Project Initiation','Identify Alternatives','Tentatively Selected Plan','Agency Decision','Senior Leaders Briefing',"Chief's Report/Director's Report")


ggplot(mockdf, aes(x=factor(ID, level=c(level_order)), y=yval))+
  geom_segment(x=1, y = 0.15, xend = 6, yend = 0.15, size=1.5, color = "grey")+
  geom_point(size=8,color="grey", fill="snow1", shape=21, stroke=1.5)+
  geom_point(aes(x=risk_item$MILESTONE, y=0.15), colour="deepskyblue2", fill="deepskyblue2", shape = 21, size =8, stroke=1.5)+
  geom_text(aes(label=xwrap), position="nudge", vjust=1.7)+
  scale_y_continuous(expand=c(0,0))+
  coord_cartesian(ylim=c(0.15,0.15))+
  theme(line = element_blank(),
        title = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.length = unit(0, "pt"),
        panel.background = element_blank(),
        )+
  theme(plot.margin=unit(c(0,0,0,0),"mm"))


```

```{r , echo=FALSE, fig.align='center' }
knitr::include_graphics("C:/workspace/e-rarr/images/montecarlo.png")
```

### Lead Discipline: `r risk_item$DISCIPLINE`

#### `r risk_item$RISK_STATEMENT`

## Event Likelihood: `r risk_item$LIKELIHOOD_DISC`

`r risk_item$PROB_OCCURRENCE_EVIDENCE`

| Cost Impact                                   | Schedule Impact                                      | Performance Impact                                                 |
|--------------------|-----------------------|-----------------------------|
| *Lowest* \$`r risk_item$COST_IMPACT_LOWEST`   | *Lowest* `r risk_item$SCHEDULE_IMPACT_LOWEST` days   | ***Performance Impact:*** `r risk_item$PERFORMANCEIMPACT_DESC`     |
| *Highest* \$`r risk_item$COST_IMPACT_HIGHEST` | *Highest* `r risk_item$SCHEDULE_IMPACT_HIGHEST` days | ***Performance Impact Type:*** `r risk_item$PERFORMANCEIMPACTTYPE` |
| `r risk_item$COST_IMPACT_EVIDENCE`            | `r risk_item$SCHEDULE_IMPACT_EVIDENCE`               | `r risk_item$PERFORMANCEIMPACT_DESC`                               |

## Risk Treatments

```{r, echo=FALSE}
risk_treat_table$IMPLEMENT_IMG = sprintf("![](%s)", risk_treat_table$IMPLEMENT_IMG)
kbl(risk_treat_table,"html",col.names = NULL) %>%
  add_header_above(c("Measures"=2, "Impacts" = 2,"Implemented" = 1))


```

```{r, include=FALSE, echo=FALSE, warning = FALSE}
risk_transact <- read_csv("data/RiskTransaction_FullView.csv")
risk_log<-data.frame(risk_transact)
risk_log<-risk_log %>%
  mutate('costcolor' = case_when(COST_RISK_RANKING == 0 ~ 'deepskyblue',
  COST_RISK_RANKING ==1 ~'green', 
  COST_RISK_RANKING == 2 ~'orange',
  COST_RISK_RANKING ==  3 ~ 'red')) %>%
  mutate('schedulecolor' = case_when(SCHEDULE_RISK_RANKING == 0 ~ 'deepskyblue',
  SCHEDULE_RISK_RANKING ==1 ~'green', 
  SCHEDULE_RISK_RANKING == 2 ~'orange',
  SCHEDULE_RISK_RANKING ==  3 ~ 'red')) %>%
  mutate('performancecolor' = case_when(PERFORMANCEIMPACT_RISK_RANKING == 0 ~ 'deepskyblue',
  PERFORMANCEIMPACT_RISK_RANKING ==1 ~'green', 
  PERFORMANCEIMPACT_RISK_RANKING == 2 ~'orange',
  PERFORMANCEIMPACT_RISK_RANKING ==  3 ~ 'red'))%>%
  mutate(TREAT_IMPLEMENT_IMG = if_else(is.na(TREATMENTS_IMPLEMENTED), NA, imagepath))
         
         
risk_item_log<-filter(risk_log, RISK_ID == 7, PROJECT_ID == 3069)
risk_log_table<-risk_item_log %>%
  select(DATE_TIME, REASON, RISK_LOG_NOTE, TREAT_IMPLEMENT_IMG, COST_RISK_RANKING, SCHEDULE_RISK_RANKING, PERFORMANCEIMPACT_RISK_RANKING, costcolor, schedulecolor, performancecolor )
```

## Risk Log:

```{r, echo=FALSE}
risk_log_table$TREAT_IMPLEMENT_IMG = sprintf("![](%s)", risk_log_table$TREAT_IMPLEMENT_IMG)
risk_log_table[1:7]%>%
kbl("html", col.names =c("Edit Date", "Reason for Change", "Risk Log Note",  "Measures Implemented", "Cost","Schedule","Performance")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>%
  column_spec(5,color="black", background=risk_log_table$costcolor)%>%
  column_spec(6,color="black", background=risk_log_table$schedulecolor)%>%
  column_spec(7,color="black", background=risk_log_table$performancecolor)

                                                    
```
