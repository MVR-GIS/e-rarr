---
title: ""
output: html_document
params:
  riskID: Cultural Resources Surveys
  projID: St. Augustine Back Bay CSRM
  p2ID: 479265
runtime: shiny
---

```{css, echo=FALSE}
h1, h4 {
  text-align: center;
}
```

```{r echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library(readr) 
library(magrittr) 
library(dplyr) 
library(kableExtra) 
library(rlang)
library(plotly)
library(ggplot2)
library(ggrepel)
library(dplyr)
library(knitr)
library(crosstalk)
library(tidyverse)
library(leaflet)
library(english)
library(DT)
options(scipen = 999)

#erisk_item_old <- read_csv("C:/workspace/e-rarr/RiskItemReportShinyApp/data/RiskItem_FullView_Update.csv")
erisk_item <- read.csv("C:/workspace/e-rarr/RiskItemReportShinyApp/data/RISKLIST_FULL.csv")
risk_item_db<-data.frame(erisk_item)
erisk_project <- read_csv("C:/workspace/e-rarr/RiskItemReportShinyApp/data/PROJECTLIST_FULL.csv")
risk_project_db<-data.frame(erisk_project)
risk_treat <- read_csv("C:/workspace/e-rarr/RiskItemReportShinyApp/data/RISKTREATMENTLIST_FULL.csv",col_names = TRUE)
imagepath<-"C:/workspace/e-rarr/RiskItemReportShinyApp/www/check.png"
risk_transact <- read_csv("C:/workspace/e-rarr/RiskItemReportShinyApp/data/RISKTRANSACTIONLIST_FULL.csv")

erisk_ItemProj<-left_join(risk_item_db, risk_project_db, by = "PROJECT_ID")                                                                                                                          
risk_item_filt<- risk_item_db |>
  select(RISK_ID, PROJECT_ID, RISK_NAME , PROJECT_NAME, P2_NUMBER)



RiskImpactTable<-erisk_ItemProj |>
  select("RISK_ID","RISK_IDENTIFIER","P2_NUMBER.x", "PROJECT_ID","PROJECT_NAME.x", "RISK_NAME","RISKCATEGORY", "DISCIPLINE", "RISK_STATEMENT","LIKELIHOOD_DESC", "PROB_OCCURRENCE_EVIDENCE",  "COST_IMPACT_LOWEST", "COST_IMPACT_MOSTLIKELY", "COST_IMPACT_HIGHEST", "COST_IMPACT_EVIDENCE","SCHEDULE_IMPACT_LOWEST", "SCHEDULE_IMPACT_MOSTLIKELY", "SCHEDULE_IMPACT_HIGHEST", "SCHEDULE_IMPACT_EVIDENCE", "LIFECYCLEPHASENAME.x", "PERFORMANCEIMPACT_DESC", "PERFORMANCEIMPACT" , "MILESTONE", "RISK_MANAGER", "COST_IMPACT_DISTTYPE", "SCHEDULE_IMPACT_DISTTYPE", "NO_PERFORMANCE_IMPACT", "NO_COST_IMPACT","NO_SCHEDULE_IMPACT")

risk_transact<-left_join(risk_transact, risk_item_filt, by=c("PROJECT_ID", "RISK_ID"))     
risk_treat<-left_join(risk_treat, risk_item_filt, by=c("PROJECT_ID", "RISK_ID"))



```

```{r echo=FALSE, eval = params$projID != ""}
risk_item<-filter(RiskImpactTable, RiskImpactTable$RISK_NAME == params$riskID, RiskImpactTable$PROJECT_NAME.x == params$projID)
risk_treatment<-filter(risk_treat, risk_treat$PROJECT_NAME == params$projID, risk_treat$RISK_NAME == params$riskID)

```

```{r echo=FALSE, eval = params$p2ID != ""}
risk_item<-filter(RiskImpactTable, RiskImpactTable$RISK_NAME == params$riskID, RiskImpactTable$P2_NUMBER == params$p2ID)
risk_treatment<-filter(risk_treat, risk_treat$PROJECT_NAME == params$projID, risk_treat$RISK_NAME == params$riskID)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
risk_item_table<- risk_item |>
  select(COST_IMPACT_LOWEST,COST_IMPACT_HIGHEST, COST_IMPACT_EVIDENCE,SCHEDULE_IMPACT_LOWEST, SCHEDULE_IMPACT_HIGHEST, SCHEDULE_IMPACT_EVIDENCE,PERFORMANCEIMPACT_DESC, PERFORMANCEIMPACT, PERFORMANCEIMPACT_DESC, SCHEDULE_IMPACT_DISTTYPE)


risk_treat_table<-risk_treatment |>
  select(RISK_TREATMENT_ID,PROPOSED_RISK_TREATMENT,COST_IMPACT_RISK_TREATMENT,
         SCHEDULE_IMPACT_RISK_TREATMENT, IMPLEMENTED, RISK_NAME) |>
  mutate(IMPLEMENT_IMG = case_when(
    IMPLEMENTED == 1 ~ imagepath,
    IMPLEMENTED == 0 ~ " ")) |>
  select(RISK_TREATMENT_ID,PROPOSED_RISK_TREATMENT,COST_IMPACT_RISK_TREATMENT,
         SCHEDULE_IMPACT_RISK_TREATMENT, IMPLEMENT_IMG) |>
  mutate(PROPOSED_RISK_TREATMENT = paste0(( "Measure "), str_to_title(english::english(RISK_TREATMENT_ID)),": ",PROPOSED_RISK_TREATMENT )) |>
  mutate(SCHEDULE_IMPACT_RISK_TREATMENT = paste(SCHEDULE_IMPACT_RISK_TREATMENT, "Days"))

treat_condit <- ifelse(nrow(risk_treat_table)>0,TRUE,FALSE)

    
```

#### Project: `r risk_item$PROJECT_NAME.x`

#### Risk Phase: `r risk_item$LIFECYCLEPHASENAME`, Category: `r risk_item$RISKCATEGORY`

# Risk Summary: `r risk_item$RISK_NAME`

```{r milestoneplot, fig.align='center', fig.height=1.75, fig.width=7, message=FALSE, warning=FALSE, echo=FALSE}
mockdf<- data.frame(ID = c("Project Initiation","Identify Alternatives","Tentatively Selected Plan","Agency Decision","Senior Briefing","Chief/Director's Report"),
                    yval = c(0.15,0.15,0.15,0.15,0.15,0.15),
                    xval = c(1,2,3,4,5,6))
mockdf$xwrap = str_wrap(mockdf$ID, width=14)
level_order<-c('Project Initiation','Identify Alternatives','Tentatively Selected Plan','Agency Decision','Senior Briefing',"Chief Report/Director's Report")




ggplot(mockdf, aes(x=factor(ID, level=c(level_order)), y=yval))+
  geom_segment(x=1, y = 0.15, xend = 6, yend = 0.15, size=1.5, color = "grey")+
  geom_point(size=8,color="grey", fill="snow1", shape=21, stroke=1.5)+
  geom_point(aes(x=risk_item$MILESTONE, y=0.15), colour="#1F78B4", fill="#1F78B4", shape = 21, size =8, stroke=1.5)+
  geom_text(aes(label=xwrap), position="nudge", vjust=1.7)+
  scale_y_continuous(expand=c(0,0))+
  coord_cartesian(ylim=c(0.15,0.15))+
  theme(line = element_blank(),
        title = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.length = unit(0, "pt"),
        panel.background = element_blank(),
        )+
  theme(plot.margin=unit(c(0,0,0,0),"mm"))


```

##### **Lead Discipline:** `r risk_item$DISCIPLINE`

##### `r risk_item$RISK_STATEMENT`

```{r , echo=FALSE, fig.align='center' }
knitr::include_graphics("C:/workspace/e-rarr/RiskItemReportShinyApp/www/montecarlo.png")
```

#### **Event Likelihood:** `r risk_item$LIKELIHOOD_DISC`

#### `r risk_item$PROB_OCCURRENCE_EVIDENCE`


#### **No Impact**

| Cost Impact                 | Schedule Impact                   | Performance Impact                   |
|---------------------|-------------------------|---------------------------|
| No Cost Impact anticipated. | No Schedule Impact is Anticipated | No Performance Impact is anticipated |

#### **Uniform Example**

| Cost Impact                                   | Schedule Impact                                      | Performance Impact                                                 |
|--------------------|-----------------------|-----------------------------|
| *Lowest* \$`r risk_item$COST_IMPACT_LOWEST`   | *Lowest* `r risk_item$SCHEDULE_IMPACT_LOWEST` days   | ***Performance Impact:*** `r risk_item$PERFORMANCEIMPACT_DESC`     |
| *Highest* \$`r risk_item$COST_IMPACT_HIGHEST` | *Highest* `r risk_item$SCHEDULE_IMPACT_HIGHEST` days | ***Performance Impact Type:*** `r risk_item$PERFORMANCEIMPACT` |
| `r risk_item$COST_IMPACT_EVIDENCE`            | `r risk_item$SCHEDULE_IMPACT_EVIDENCE`               | `r risk_item$PERFORMANCEIMPACT_DESC`                               |

| Cost Impact                                 | Schedule Impact                                    | Performance Impact                                             |
|---------------------|------------------------|---------------------------|
| *Lowest* \$`r risk_item$COST_IMPACT_LOWEST` | *Lowest* `r risk_item$SCHEDULE_IMPACT_LOWEST` days | ***Performance Impact:*** `r risk_item$PERFORMANCEIMPACT_DESC` |

#### **Point Estimate Example**

| Cost Impact                                      | Schedule Impact                                      | Performance Impact                                                                                                         |
|-------------------|-------------------|-----------------------------------|
| Most Likely `r risk_item$COST_IMPACT_MOSTLIKELY` | Most Likely `r risk_item$SCHEDULE_IMPACT_MOSTLIKELY` | ***Performance Impact:*** `r risk_item$PERFORMANCEIMPACT_DESC` Performance Impact Type: `r risk_item$PERFORMANCIMPACTTYPE` |
| `r risk_item$COST_IMPACT_EVIDENCE`               | `r risk_item$SCHEDULE_IMPACT_EVIDENCE`               | `r risk_item$PERFORMANCEIMPACT_DESC`                                                                                       |

#### Risk Treatments:

`r if(!treat_condit){"Risk treatments have not been completed for this risk item"}`

```{r echo=FALSE, message=FALSE, eval = treat_condit}
risk_treat_table$IMPLEMENT_IMG = sprintf("![    ](%s)", risk_treat_table$IMPLEMENT_IMG)


kbl(risk_treat_table,format = "html",col.names = NULL, align= "llccc") |>
  kable_styling() |>
  add_header_above(c("Measures"=2, "Impacts" = 2,"Implemented" = 1))


```

                                                
##### Risk Manager: `r risk_item$RISK_MANAGER` 
